<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             x:Class="De.HDBW.Apollo.Client.Views.AssessmentView"
             xmlns:viewModels="clr-namespace:De.HDBW.Apollo.Client.ViewModels"
             xmlns:contracts="clr-namespace:De.HDBW.Apollo.Client.Contracts"
             xmlns:assessmentModels="clr-namespace:De.HDBW.Apollo.Client.Models.Assessment"
             x:DataType="viewModels:AssessmentViewModel"
             xmlns:selector="clr-namespace:De.HDBW.Apollo.Client.Selector"
             xmlns:strings="clr-namespace:De.HDBW.Apollo.Client.Resources.Strings"
             IsBusy="{Binding IsBusy}">
    <ContentPage.Resources>

        <DataTemplate x:Key="DefaultAnswerTemplate" x:DataType="assessmentModels:AnswerEntry">
            <Label Text="{Binding Text}" />
        </DataTemplate>

        <DataTemplate x:Key="ImageAnswerTemplate" x:DataType="assessmentModels:AnswerEntry">
            <Grid>
                <Image Source="{Binding ImagePath}" IsVisible="{Binding HasImage}" MinimumHeightRequest="50" MaximumHeightRequest="50"/>
            </Grid>
        </DataTemplate>

        <DataTemplate x:Key="ImageWithTextTemplate" x:DataType="assessmentModels:AnswerEntry">
            <Grid >
                <Image Source="{Binding ImagePath}" MinimumHeightRequest="50" MaximumHeightRequest="50"/>
                <Label Text="{Binding Text}" />
            </Grid>
        </DataTemplate>

         <DataTemplate x:Key="PointTemplate" x:DataType="assessmentModels:AnswerEntry">
            <AbsoluteLayout WidthRequest="0" HeightRequest="0">
                <Ellipse Margin="-5,-5,-5,-5" WidthRequest="10" HeightRequest="10" Fill="Red" />
            </AbsoluteLayout>
        </DataTemplate>

        <selector:SelectionAnswersTemplateSelector x:Key="SelectionAnswersTemplateSelector"
                                           DefaultTemplate="{StaticResource DefaultAnswerTemplate}"
                                           BooleanImageTemplate="{StaticResource ImageAnswerTemplate}"
                                           BooleanImageWithTextTemplate="{StaticResource ImageWithTextTemplate}"
                                           DefaultBooleanTemplate="{StaticResource DefaultAnswerTemplate}"
                                           DefaultIntegerTemplate="{StaticResource DefaultAnswerTemplate}"
                                           DefaultLongTemplate="{StaticResource DefaultAnswerTemplate}"
                                           DefaultLocationTemplate="{StaticResource DefaultAnswerTemplate}"
                                           DefaultStringTemplate="{StaticResource DefaultAnswerTemplate}"/>

        <DataTemplate x:Key="SelectionInteractionTemplate" x:DataType="contracts:ISelectionInteractiveEntry">
            <Grid Background="Transparent">
                <Grid.GestureRecognizers>
                    <TapGestureRecognizer NumberOfTapsRequired="1" Command="{Binding ToggleSelectionCommand}" />
                </Grid.GestureRecognizers>
                <StackLayout BindableLayout.ItemTemplateSelector="{StaticResource SelectionAnswersTemplateSelector}" BindableLayout.ItemsSource="{Binding Data, Converter={StaticResource SingleItemListConverter}}" />
                <CheckBox IsChecked="{Binding IsSelected, Mode=TwoWay}" InputTransparent="True" HorizontalOptions="End" VerticalOptions="End"/>
            </Grid>
        </DataTemplate>

        <DataTemplate x:Key="DefaultInteractionTemplate" x:DataType="contracts:IInteractiveEntry">
             <StackLayout BindableLayout.ItemTemplateSelector="{StaticResource AnswersTemplateSelector}" BindableLayout.ItemsSource="{Binding Data, Converter={StaticResource SingleItemListConverter}}" />
        </DataTemplate>
        
        <selector:IInteractiveEntryTemplateSelector x:Key="IInteractiveEntryTemplateSelector"
                                                   DefaultTemplate="{StaticResource DefaultInteractionTemplate}"
                                                   SelectInteractionTemplate="{StaticResource SelectionInteractionTemplate}"/>

        <DataTemplate x:Key="DefaultAnswerLayoutTemplate">
            <CollectionView
                VerticalScrollBarVisibility="Never"
                HorizontalScrollBarVisibility="Never"
                ItemsSource="{Binding Source={RelativeSource AncestorType={x:Type assessmentModels:QuestionEntry}}, Path=Answers}"
                ItemTemplate="{StaticResource IInteractiveEntryTemplateSelector}">
                <CollectionView.ItemsLayout>
                    <LinearItemsLayout Orientation="Vertical" />
                </CollectionView.ItemsLayout>
            </CollectionView>
        </DataTemplate>
        
        <DataTemplate x:Key="HorizontalAnswerLayoutTemplate">
            <CollectionView
                VerticalScrollBarVisibility="Never"
                HorizontalScrollBarVisibility="Default"
                ItemsSource="{Binding Source={RelativeSource AncestorType={x:Type assessmentModels:QuestionEntry}}, Path=Answers}"
                ItemTemplate="{StaticResource IInteractiveEntryTemplateSelector}">
                <CollectionView.ItemsLayout>
                    <LinearItemsLayout Orientation="Horizontal" />
                </CollectionView.ItemsLayout>
            </CollectionView>
        </DataTemplate>
        
        <DataTemplate x:Key="UniformAnswerLayoutTemplate">
            <CollectionView
                VerticalScrollBarVisibility="Never"
                HorizontalScrollBarVisibility="Never"
                ItemsSource="{Binding Source={RelativeSource AncestorType={x:Type assessmentModels:QuestionEntry}}, Path=Answers}"
                ItemTemplate="{StaticResource IInteractiveEntryTemplateSelector}">
                <CollectionView.ItemsLayout>
                    <GridItemsLayout Orientation="Vertical" Span="2" />
                </CollectionView.ItemsLayout>
            </CollectionView>
        </DataTemplate>
        
        <selector:AnswersLayoutTemplateSelector x:Key="AnswersLayoutTemplateSelector"
                                           DefaultTemplate="{StaticResource DefaultAnswerLayoutTemplate}"
                                           HorizontalTemplate="{StaticResource HorizontalAnswerLayoutTemplate}"
                                           UniformTemplate="{StaticResource UniformAnswerLayoutTemplate}" />
        
        <DataTemplate x:Key="DefaultQuestionTemplate" x:DataType="assessmentModels:QuestionEntry">
            <ScrollView VerticalScrollBarVisibility="Never" HorizontalScrollBarVisibility="Default" VerticalOptions="FillAndExpand" >
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="auto" />
                        <RowDefinition Height="auto" />
                        <RowDefinition Height="auto" />
                        <RowDefinition Height="auto" />
                    </Grid.RowDefinitions>
                    <Label Text="{Binding Question}" Grid.Row="0"/>
                    <Label Text="{Binding Instruction}" HorizontalTextAlignment="End" Grid.Row="1"/>
                    <Image Source="{Binding ImagePath}" HeightRequest="200" Grid.Row="2" IsVisible="{Binding HasImage}" />
                    <StackLayout Grid.Row="3" BindableLayout.ItemTemplateSelector="{StaticResource AnswersLayoutTemplateSelector}" BindableLayout.ItemsSource="{Binding AnswerLayout, Converter={StaticResource SingleItemListConverter}}">
                    </StackLayout>
                </Grid>
            </ScrollView>
        </DataTemplate>

        <DataTemplate x:Key="CompareQuestionTemplate" x:DataType="assessmentModels:QuestionEntry">
            <ScrollView VerticalScrollBarVisibility="Never" HorizontalScrollBarVisibility="Default" VerticalOptions="FillAndExpand" >
                <Grid Background="Orange">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="auto" />
                        <RowDefinition Height="auto" />
                        <RowDefinition Height="auto" />
                        <RowDefinition Height="*" />
                        <RowDefinition Height="*" />
                    </Grid.RowDefinitions>
                    <Label Text="{Binding Question}" Grid.Row="0"/>
                    <Label Text="{Binding Instruction}" Grid.Row="1"/>
                    <Grid ColumnDefinitions="*,*" Grid.Row="2">
                        <Button Text="Test" />
                        <Button Text="Test" Grid.Column="1" />
                    </Grid>
                    <CarouselView Grid.Row="3">
                        <CarouselView.ItemTemplate>
                            <DataTemplate>
                                <Grid>
                                    <Image Source="untitled.png"/>
                                </Grid>
                            </DataTemplate>
                        </CarouselView.ItemTemplate>
                        <CarouselView.ItemsSource>
                            <x:Array Type="{x:Type x:String}">
                                <x:String>A1</x:String>
                                <x:String>A2</x:String>
                            </x:Array>
                        </CarouselView.ItemsSource>
                    </CarouselView>
                    <CollectionView Grid.Row="4">
                        <CollectionView.ItemTemplate>
                            <DataTemplate>
                                <Frame>
                                    <Label Text="{Binding}" />
                                </Frame>
                            </DataTemplate>
                        </CollectionView.ItemTemplate>
                        <CollectionView.ItemsSource>
                            <x:Array Type="{x:Type x:String}">
                                <x:String>A1</x:String>
                                <x:String>A2</x:String>
                                <x:String>A3</x:String>
                                <x:String>A4</x:String>
                            </x:Array>
                        </CollectionView.ItemsSource>
                    </CollectionView>
                </Grid>
            </ScrollView>
        </DataTemplate>

        <DataTemplate x:Key="OverlayQuestionTemplate" x:DataType="assessmentModels:QuestionEntry">
            <ScrollView VerticalScrollBarVisibility="Never" HorizontalScrollBarVisibility="Default" VerticalOptions="FillAndExpand" >
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="auto" />
                        <RowDefinition Height="auto" />
                        <RowDefinition Height="auto" />
                    </Grid.RowDefinitions>
                    <Label Text="{Binding Question}" Grid.Row="0"/>
                    <Label Text="{Binding Instruction}" HorizontalTextAlignment="End" Grid.Row="1"/>
                    <Image Source="{Binding ImagePath}" HeightRequest="200" Grid.Row="2" IsVisible="{Binding HasImage}"/>
                    <StackLayout Grid.Row="2" BindableLayout.ItemTemplateSelector="{StaticResource AnswersLayoutTemplateSelector}" BindableLayout.ItemsSource="{Binding AnswerLayout, Converter={StaticResource SingleItemListConverter}}">
                    </StackLayout>
                </Grid>
            </ScrollView>
        </DataTemplate>

        <selector:QuestionTemplateSelector x:Key="QuestionTemplateSelector"
                                           DefaultTemplate="{StaticResource DefaultQuestionTemplate}"
                                           CompareTemplate="{StaticResource CompareQuestionTemplate}"
                                           OverlayTemplate="{StaticResource OverlayQuestionTemplate}"/>
    </ContentPage.Resources>
    <Grid RowDefinitions="auto,auto,*,auto">
        <StackLayout>
            <Picker Title="Interaction" TitleColor="White" TextColor="White" ItemsSource="{Binding Interactions}" SelectedItem="{Binding Interaction, Mode=TwoWay}" BackgroundColor="{StaticResource Primary}" />
            <Picker Title="QuestionLayout" TitleColor="White" TextColor="White" ItemsSource="{Binding QuestionLayouts}" SelectedItem="{Binding QuestionLayout, Mode=TwoWay}" BackgroundColor="{StaticResource Primary}" />
            <Picker Title="AnserwerLayout" TitleColor="White" TextColor="White" ItemsSource="{Binding AnswerLayouts}" SelectedItem="{Binding AnswerLayout, Mode=TwoWay}" BackgroundColor="{StaticResource Primary}" />
        </StackLayout>

        <ProgressBar Grid.Row="1" Progress="{Binding Progress}" />
        <StackLayout Grid.Row="2" BindableLayout.ItemTemplateSelector="{StaticResource QuestionTemplateSelector}" BindableLayout.ItemsSource="{Binding CurrentQuestion, Converter={StaticResource SingleItemListConverter}}" >

        </StackLayout>
        <Button Grid.Row="3" Text="Next" Command="{Binding NextQuestionCommand}"/>
    </Grid>
</ContentPage>
